# trigger:
# - main

# variables:
#   nodeVersion: '18.x'
#   artifactName: 'nodejs-app'
#   azureSubscription: 'azure-appservice-connection'
#   webAppNameDev: 'nodejs-demo-app-test'
#   webAppNameProd: 'nodejs-demo-app-test'

# stages:
# # ================= CI STAGE =================
# - stage: CI
#   displayName: 'Build and Test'
#   jobs:
#   - job: Build
#     pool:
#       name: self-hosted-pool
#     steps:
#     - checkout: self

#     - task: NodeTool@0
#       inputs:
#         versionSpec: '$(nodeVersion)'
#       displayName: 'Install Node.js'

#     - script: npm install
#       displayName: 'Install dependencies'

#     - script: npm test -- --ci
#       displayName: 'Run unit tests'

#     - task: PublishTestResults@2
#       inputs:
#         testResultsFormat: 'JUnit'
#         testResultsFiles: '**/test-results/junit.xml'
#         failTaskOnFailedTests: true
#       displayName: 'Publish test results'

#     - script: |
#         mkdir dist
#         xcopy app dist\app /E /I
#         xcopy assets dist\assets /E /I
#         copy package.json dist\
#         copy package-lock.json dist\
#       displayName: 'Prepare build artifact'

#     - task: PublishPipelineArtifact@1
#       displayName: 'Publish pipeline artifact'
#       inputs:
#         targetPath: 'dist'
#         artifact: 'nodejs-app'

# # ================= CD DEV =================
# - stage: Deploy_Dev
#   displayName: 'Deploy to Dev'
#   dependsOn: CI
#   jobs:
#   - deployment: DeployDev
#     environment: dev
#     pool:
#       name: self-hosted-pool
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: nodejs-app

#           - task: AzureWebApp@1
#             displayName: 'Deploy to Dev App Service'
#             inputs:
#               azureSubscription: $(azureSubscription)
#               appType: 'webAppLinux'
#               appName: $(webAppNameDev)
#               package: '$(Pipeline.Workspace)/$(artifactName)'

# # ================= CD PROD =================
# - stage: Deploy_Prod
#   displayName: 'Deploy to Production'
#   dependsOn: Deploy_Dev
#   jobs:
#   - deployment: DeployProd
#     environment: prod   # approval happens here
#     pool:
#       name: self-hosted-pool
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - download: current
#             artifact: $(artifactName)

#           - task: AzureWebApp@1
#             displayName: 'Deploy to Prod App Service'
#             inputs:
#               azureSubscription: $(azureSubscription)
#               appType: 'webAppLinux'
#               appName: $(webAppNameProd)
#               package: '$(Pipeline.Workspace)/$(artifactName)'

trigger:
- main

variables:
  nodeVersion: '18.x'
  artifactName: 'nodejs-app'
  azureSubscription: 'azure-appservice-connection'
  webAppName: 'nodejs-demo-app-test'   # same app for demo

stages:
# ================= CI =================
- stage: CI
  displayName: 'Build and Test'
  jobs:
  - job: Build
    pool:
      name: self-hosted-pool
    steps:
    - checkout: self
    
    - task: SonarQubePrepare@4
      displayName: 'Prepare SonarCloud analysis'
      inputs:
        SonarQube: 'sonarqube-connection'
        scannerMode: 'CLI'
        configMode: 'file'

    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: npm install
      displayName: 'Install dependencies'

    - script: npm test -- --ci
      displayName: 'Run unit tests'

     #  Run SonarCloud analysis
    - task: SonarQubeAnalyze@4
      displayName: 'Run SonarCloud analysis'

    #  Enforce Quality Gate (FAILS CI if not passed)
    - task: SonarQubePublish@4
      displayName: 'Publish Quality Gate Result'
      inputs:
        pollingTimeoutSec: '300' 

    - script: |
        mkdir dist
        xcopy app dist\app /E /I
        xcopy assets dist\assets /E /I
        copy package.json dist\
        copy package-lock.json dist\
      displayName: 'Prepare build artifact'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish artifact'
      inputs:
        targetPath: 'dist'
        artifact: '$(artifactName)'

# ================= DEV =================
- stage: Deploy_Dev
  displayName: 'Deploy to Dev'
  dependsOn: CI
  condition: succeeded()   # runs only if CI + Sonar passed
  variables:
  - group: dev-vars
  jobs:
  - deployment: DevDeploy
    environment: dev
    pool:
      name: self-hosted-pool
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: $(artifactName)

          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(webAppName)
              package: '$(Pipeline.Workspace)/$(artifactName)'
              appSettings: |
                -NODE_ENV $(NODE_ENV)

# ================= TEST =================
- stage: Deploy_Test
  displayName: 'Deploy to Test'
  dependsOn: Deploy_Dev
  variables:
  - group: test-vars
  jobs:
  - deployment: TestDeploy
    environment: test
    pool:
      name: self-hosted-pool
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: $(artifactName)

          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(webAppName)
              package: '$(Pipeline.Workspace)/$(artifactName)'
              appSettings: |
                -NODE_ENV $(NODE_ENV)

# ================= PROD =================
- stage: Deploy_Prod
  displayName: 'Deploy to Prod'
  dependsOn: Deploy_Test
  variables:
  - group: prod-vars
  jobs:
  - deployment: ProdDeploy
    environment: prod   # approval happens here
    pool:
      name: self-hosted-pool
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: $(artifactName)

          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(webAppName)
              package: '$(Pipeline.Workspace)/$(artifactName)'
              appSettings: |
                -NODE_ENV $(NODE_ENV)
                

